[workspace]
name = "sasvi"
channels = ["pytorch", "nvidia", "conda-forge"]
platforms = ["linux-64"]

[system-requirements]
cuda = "12"

[dependencies]
# Python version (from README: python=3.11)
python = "3.11.*"
pip = ">=24.0"

# PyTorch with CUDA support
pytorch = ">=2.3.1"
torchvision = ">=0.18.1"
pytorch-cuda = "==12.1"

# ===== From requirements.txt =====
numpy = "==1.26.3"
scikit-image = "==0.22.0"
matplotlib = ">=3.7.0"
pandas = ">=2.0.0"
tqdm = ">=4.65.0"
natsort = ">=8.4.0"

# ===== Additional dependencies =====
ffmpeg = ">=6.0"
libjpeg-turbo = ">=2.1.0"
opencv = ">=4.8.0"
pyyaml = ">=6.0"
hydra-core = ">=1.3.0"
scipy = ">=1.10.0"
pillow = ">=10.0.0"
wget = ">=1.20"

[pypi-dependencies]
# From requirements.txt
albumentations = "==1.3.1"
jpeg4py = "*"
torchprofile = "*"


# Additional PyPI packages
pycocotools = ">=2.0.7"
timm = ">=0.9.0"
einops = ">=0.7.0"
imageio = ">=2.31.0"
imageio-ffmpeg = ">=0.4.8"

# Hugging Face Hub for downloading overseer checkpoints
huggingface-hub = ">=0.20.0"

[tasks]
# ===== SDS_Playground Setup =====
clone-sds-playground = "git clone https://github.com/MECLabTUDA/SDS_Playground.git sds_playground"
install-sds-playground = { cmd = "pip install -e sds_playground/", depends-on = ["clone-sds-playground"] }

# ===== SAM2 Setup =====
install-sam2 = "cd forked_SASVi/src/sam2 && pip install -e ."

# ===== SAM2 Checkpoints =====
create-sam2-checkpoints-dir = "mkdir -p forked_SASVi/src/sam2/checkpoints"

download-sam2-tiny = { cmd = "wget -nc -P forked_SASVi/src/sam2/checkpoints https://dl.fbaipublicfiles.com/segment_anything_2/092824/sam2.1_hiera_tiny.pt", depends-on = ["create-sam2-checkpoints-dir"] }
download-sam2-small = { cmd = "wget -nc -P forked_SASVi/src/sam2/checkpoints https://dl.fbaipublicfiles.com/segment_anything_2/092824/sam2.1_hiera_small.pt", depends-on = ["create-sam2-checkpoints-dir"] }
download-sam2-base-plus = { cmd = "wget -nc -P forked_SASVi/src/sam2/checkpoints https://dl.fbaipublicfiles.com/segment_anything_2/092824/sam2.1_hiera_base_plus.pt", depends-on = ["create-sam2-checkpoints-dir"] }
download-sam2-large = { cmd = "wget -nc -P forked_SASVi/src/sam2/checkpoints https://dl.fbaipublicfiles.com/segment_anything_2/092824/sam2.1_hiera_large.pt", depends-on = ["create-sam2-checkpoints-dir"] }

download-sam2-checkpoints = { depends-on = ["download-sam2-tiny", "download-sam2-small", "download-sam2-base-plus", "download-sam2-large"] }

# ===== Overseer Checkpoints (from Hugging Face) =====
create-overseer-checkpoints-dir = """
mkdir -p forked_SASVi/checkpoints/cadis/detr && \
mkdir -p forked_SASVi/checkpoints/cadis/mask2former && \
mkdir -p forked_SASVi/checkpoints/cadis/maskrcnn && \
mkdir -p forked_SASVi/checkpoints/cataract1k/detr && \
mkdir -p forked_SASVi/checkpoints/cataract1k/mask2former && \
mkdir -p forked_SASVi/checkpoints/cataract1k/maskrcnn && \
mkdir -p forked_SASVi/checkpoints/cholecseg8k/detr && \
mkdir -p forked_SASVi/checkpoints/cholecseg8k/mask2former && \
mkdir -p forked_SASVi/checkpoints/cholecseg8k/maskrcnn
"""

# Download all overseer checkpoints from Hugging Face
download-overseer-checkpoints = { cmd = "huggingface-cli download SsharvienKumar/SASVi checkpoints --repo-type model --local-dir forked_SASVi/hf_download && cp -r forked_SASVi/hf_download/checkpoints/* forked_SASVi/checkpoints/", depends-on = ["create-overseer-checkpoints-dir"] }

# ===== Full Setup =====
setup = { depends-on = ["install-sds-playground", "install-sam2", "download-sam2-checkpoints", "download-overseer-checkpoints"] }

# ===== Utility =====
check-gpu = "python -c \"import torch; print(f'CUDA available: {torch.cuda.is_available()}'); print(f'GPU count: {torch.cuda.device_count()}'); [print(f'GPU {i}: {torch.cuda.get_device_name(i)}') for i in range(torch.cuda.device_count())]\""

# List downloaded checkpoints
list-checkpoints = "find forked_SASVi/checkpoints -name '*.pth' -o -name '*.pt' | head -30"